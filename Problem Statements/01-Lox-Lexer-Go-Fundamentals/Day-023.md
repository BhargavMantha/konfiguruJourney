# Day 023: Code Quality & Refactoring

**Month 1:** Lox Lexer & Go Fundamentals
**Phase:** Foundation
**Week:** 4 of 4

---

## üéØ Today's Goal

Review and improve code quality across the entire lexer codebase. Apply Go best practices, run linters, and ensure the code is production-ready.

**Focus:** Code cleanup, Go idioms, and performance considerations

---

## üìö Learning Focus

- Go Basics
- Go Best Practices
- Code Quality
- Refactoring Techniques

**This Week:** REPL, testing & documentation

---

## ‚úÖ Tasks

### 1. Go Formatting & Linting (45 min)

**Objective:** Ensure all code follows Go conventions and passes linting checks.

**Action Items:**

Run Go's built-in formatting and linting tools:

```bash
# Format all code
go fmt ./...

# Run go vet for common mistakes
go vet ./...

# Install and run golangci-lint (optional but recommended)
# Install: https://golangci-lint.run/usage/install/
golangci-lint run
```

**Common issues to fix:**

1. **Unused variables**
   ```go
   // Bad
   func scanToken() {
       c := s.advance()
       _ = c  // Unused
   }

   // Good - use it or remove it
   func scanToken() {
       c := s.advance()
       // Use c...
   }
   ```

2. **Error handling**
   ```go
   // Bad
   value, _ := strconv.ParseFloat(text, 64)

   // Good
   value, err := strconv.ParseFloat(text, 64)
   if err != nil {
       s.addError(fmt.Sprintf("Invalid number: %s", text))
       return
   }
   ```

3. **Exported vs unexported names**
   - Public API: Start with uppercase (Scanner, Token)
   - Internal helpers: Start with lowercase (isDigit, peek)

**Checklist:**
- [ ] `go fmt ./...` runs with no changes
- [ ] `go vet ./...` reports no issues
- [ ] All exported functions have doc comments
- [ ] Consistent naming throughout codebase
- [ ] No unused variables or imports

**Verification:**
```bash
# All checks should pass
go fmt ./...
go vet ./...
go build ./...
```

---

### 2. Code Review & Refactoring (90 min)

**Objective:** Review each file for improvements in clarity, efficiency, and maintainability.

**Files to review:**

#### pkg/tokens/token.go
- [ ] Are all token types documented?
- [ ] Is the String() method complete?
- [ ] Is the keyword map comprehensive?

#### pkg/lexer/scanner.go
- [ ] Are all helper functions well-named?
- [ ] Is error handling consistent?
- [ ] Are there any repeated code patterns to extract?
- [ ] Are comments clear and helpful?

#### pkg/lexer/scanner_test.go
- [ ] Are test names descriptive?
- [ ] Is test coverage complete?
- [ ] Are edge cases tested?

#### cmd/lox/main.go
- [ ] Is the REPL user-friendly?
- [ ] Are error messages helpful?
- [ ] Is file reading robust?

**Refactoring opportunities:**

1. **Extract repeated patterns**
   ```go
   // Before: Repeated error handling
   if s.isAtEnd() {
       s.addError("Unterminated string.")
       return
   }

   // Could extract if used multiple times
   func (s *Scanner) errorIfAtEnd(message string) bool {
       if s.isAtEnd() {
           s.addError(message)
           return true
       }
       return false
   }
   ```

2. **Improve naming**
   ```go
   // Before: Unclear
   func (s *Scanner) match(expected byte) bool

   // After: More descriptive
   func (s *Scanner) matchNext(expected byte) bool
   ```

3. **Add doc comments**
   ```go
   // Before: No comment
   func NewScanner(source string) *Scanner {

   // After: Documented
   // NewScanner creates a new lexical scanner for the given source code.
   // The scanner tokenizes the source according to Lox language rules.
   func NewScanner(source string) *Scanner {
   ```

**Checklist:**
- [ ] All functions have clear, single responsibilities
- [ ] Variable names are descriptive
- [ ] Magic numbers replaced with constants
- [ ] Complex logic has explanatory comments
- [ ] No duplicate code

**Commit checkpoint:**
```bash
git add .
git commit -m "refactor: improve code clarity and Go idioms

- Add doc comments to all exported functions
- Extract repeated patterns
- Improve variable naming
- Fix linting issues"
```

---

### 3. Performance Considerations (45 min)

**Objective:** Identify and document performance characteristics, with simple optimizations where appropriate.

**Areas to review:**

1. **String operations**
   - Are we creating unnecessary string copies?
   - Can we use byte comparisons instead of string comparisons?

   ```go
   // Current approach (fine for learning)
   text := s.source[s.start:s.current]

   // Note: This creates a new string, but that's OK
   // for a learning lexer. Don't over-optimize!
   ```

2. **Memory allocations**
   - Pre-allocate slices when size is known

   ```go
   // Before
   tokens := make([]tokens.Token, 0)

   // After (if you know approx size)
   tokens := make([]tokens.Token, 0, 100) // Capacity hint
   ```

3. **Lookup operations**
   - Keyword map is O(1) - good!
   - Token string conversion uses switch - could use array, but switch is fine

**Benchmarking (optional learning):**

Create `pkg/lexer/scanner_bench_test.go`:

```go
package lexer

import (
    "testing"
)

func BenchmarkScanTokens(b *testing.B) {
    source := `var x = 10;
    var y = 20;
    var result = x + y;
    print result;`

    for i := 0; i < b.N; i++ {
        scanner := NewScanner(source)
        scanner.ScanTokens()
    }
}
```

Run benchmark:
```bash
go test -bench=. ./pkg/lexer
```

**Checklist:**
- [ ] Identified performance characteristics
- [ ] No obvious performance bugs
- [ ] Documented any deliberate trade-offs
- [ ] Benchmark test created (optional)
- [ ] Performance notes added to documentation

**Performance notes to add:**

Add to README or completion doc:
- Lexer performance: O(n) where n = source length
- Memory usage: O(n) for tokens
- No performance bottlenecks for typical files

---

## üìñ Resources

### Go Best Practices
- **Effective Go:** [go.dev/doc/effective_go](https://go.dev/doc/effective_go)
- **Go Code Review Comments:** [go.dev/wiki/CodeReviewComments](https://go.dev/wiki/CodeReviewComments)
- **golangci-lint:** [golangci-lint.run](https://golangci-lint.run/)

### Refactoring
- **Refactoring Guru:** [refactoring.guru](https://refactoring.guru/)
- **Go Proverbs:** [go-proverbs.github.io](https://go-proverbs.github.io/)

---

## üí° Key Learning Points

### Code Quality Principles

1. **Readability over cleverness**
   - Clear code > Clever code
   - Name things well
   - Comment why, not what

2. **Go idioms**
   - Accept interfaces, return structs
   - Handle errors explicitly
   - Keep the zero value useful
   - Make the zero value useful

3. **Test-driven refactoring**
   - Tests give you confidence to refactor
   - Refactor without changing behavior
   - Tests should still pass after refactoring

### When to Refactor

**Do refactor when:**
- Adding a feature and code is messy
- You see duplication (DRY principle)
- Names are confusing
- Functions are too long (>50 lines)

**Don't refactor when:**
- Tests are failing
- Just before a deadline
- It works and won't be touched again
- You're making it "clever" not clearer

---

## üîç Self-Review Checklist

Use this to review your own code:

### File Level
- [ ] File has a clear, single purpose
- [ ] Package comment explains what it does
- [ ] Imports are organized (stdlib, external, internal)

### Function Level
- [ ] Function does one thing well
- [ ] Name clearly describes what it does
- [ ] Parameters are well-named
- [ ] Return values are obvious
- [ ] Error handling is consistent

### Code Level
- [ ] Variable names are descriptive
- [ ] No magic numbers (use constants)
- [ ] Comments explain why, not what
- [ ] Complex logic is broken down
- [ ] Edge cases are handled

---

## ‚úÖ Daily Checklist

- [ ] All code formatted with `go fmt`
- [ ] `go vet` passes with no issues
- [ ] Linter run (if available)
- [ ] All functions have doc comments
- [ ] Code reviewed for improvements
- [ ] Refactoring completed and tested
- [ ] Performance characteristics documented
- [ ] All tests still passing
- [ ] Changes committed with clear messages
- [ ] Learning notes updated

**Planned Time:** 3 hours

---

## üîó Navigation

- [‚Üê Day 022](Day-022.md)
- [‚Üí Day 024](Day-024.md)
- [‚Üë Month Overview](README.md)

---

## üìù Refactoring Notes

As you refactor, document:

**What you changed:**
- Example: "Renamed `match()` to `matchNext()` for clarity"

**Why you changed it:**
- Example: "The name `match` wasn't clear about what was being matched"

**What you learned:**
- Example: "Go's `go fmt` automatically handles formatting - huge time saver!"

**Future improvements:**
- Example: "Could add more detailed error messages with character position"

---

*Progress: 23/30 days complete* ‚≠ê

**Note:** Good refactoring makes code easier to understand and maintain. This is a skill that separates good developers from great ones!
